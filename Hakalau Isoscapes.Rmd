---
title: "Hakalau Isoscapes"
author: "CB Wall"
date: "2/22/2022"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r global options, warning=FALSE, message=FALSE}
if (!require('knitr')) install.packages('knitr'); library('knitr')
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# Load in packages
if (!require("pacman")) install.packages("pacman"); library(pacman) # for rapid install if not in library

# load packages
pacman::p_load("RgoogleMaps", "SDMTools", "car", "rgdal", "ggmap", "gridExtra", "automap", "cowplot","sp", "gstat", "plotrix", "dplyr", "ggplot2", "scales","magrittr","plyr","effects", "ggpubr", "sjstats", "RColorBrewer", "grid", "ggsn", "sf", "pgirmess","spdep", "ncf")

```

## Background  
**Hakalau National Forest Wildlife Refuge Isoscapes**  
Data collected 20-21 August 2019 in Hakalau Forest, Hawai'i Island. plants and plant samples collected from  afforested/restored plots after a century of deforestation from cattle grazing (now, koa plantations or *KP sites*) and remnant mixed koa-ohia forests (*RK sites*). Target engineers of forest habitats are *Acacia koa* (Hawaiian name: *Koa*), an indigenous hardwood species that forms native forest canopies and associates with nitrogen fixing bacteria. Understory species include *Rubus argutus* -- an invasive species (common name: sawtooth blackberry) -- and an endemic species *Rubus hawaiiensis* (common name: 'Ākala); both are members of the Roseaceae family. Noteably, *R. argutus* was found more in the remnant plot (i.e., RK) and the indigenous *R. hawaiiensis* was common in the restored plot (i.e, KP). 

Plants samples were collected in a spatially explicit fashion (every 4 or 5m) with a 20 x 35m superplot, consisting of thirty-five 4 x 5m subplots. This data was used to create a δ^13^C and δ^15^N stable isotope landscape, hereafter 'isoscape'. Koa and *Rubus* spp. were collected within each 4 x 5m subplot.  

*Plot densities were...*  
KP: Koa (18 trees) Rubus (14 plants) per 20 x 35m plot= *257 Koa and 200 Rubus hectare*
RK: Koa (10 trees) Rubus (28 plants) per 20 x 35m plot= *142 Koa and 400 Rubus hectare*

### Site Maps
```{r, site maps, fig.cap="Figure 1. Site map of (a) the Hawaiian Island archipelago, (b) sampling plot in Hakalau Forest Refuge, and (c) plot layouts, highlighting *Acacia koa* density.", fig.align='center', results='hide'}

# load data
HAK.gps<-read.csv("data/Hakalau.gps.csv")
API<-read.csv("data/API_key.csv")
API.key<-API[1,1]

#quick map
# ggplot(HAK.gps, aes(x = longitude, y = latitude)) + coord_quickmap() + geom_point()

######## using ggmap
register_google(key=API.key)

########
#Hawaiian islands Map
########
hi_map<-get_map(location=c(-157,20.5),zoom=7,maptype="satellite",color="color")
hi_map_for_man <- ggmap(hi_map) +
  geom_point(aes(x = -155.320, y = 19.83), pch=23,colour="black",fill="red", size = 2, stroke=0.5) +
  xlab("") + ylab("Latitude") +
  scale_y_continuous(limits=c(18.8, 22.2))+
  scale_x_continuous(limits=c(-160.2, -154)) +
  theme(axis.text=element_text(colour="black",size=5),
        axis.title=element_text(colour="black",size=8),
        plot.margin = unit(c(0, 0.5, 0, 0.7), "cm")) +
  ggsn::scalebar(x.min=-160.2, x.max=-154, y.min=18.8, y.max=22.2, dist=50, dist_unit="km", transform=TRUE,
                 st.bottom=FALSE, st.size=2, box.fill=c("gray50", "white"), model="WGS84",st.color="white", border.size=0.5)


##########
# site map plot showing distance from plots
##########
HAK.rev=c(-155.317, 19.82158002)

map2<-get_map(HAK.rev, 
                      zoom=16, 
                      scale = 2, 
                      maptype= "satellite",
                      source="google", extent= "device", legend="topright")

###
###### site single point only
site.only<-HAK.gps[c(1,5),]

Hakalau.site<-
  ggmap(map2)+
  geom_point(aes(x=longitude, y=latitude), data=site.only, alpha=0.5, color="white", size=4)+
  labs(x="", y="") +
  scale_y_continuous(limits=c(19.81785, 19.8242))+
  scale_x_continuous(limits=c(-155.3223, -155.311)) +
  theme(text = element_text(size=6),
       plot.margin = unit(c(0.2, 0.5, 0.2, 0.2), "cm")) +
  annotate("text", x=-155.3187, y=19.8225, label= "KP", size=3, col="white") +
  annotate("text", x=-155.31478, y=19.8224, label= "RK", size=3, col="white") +
ggsn::scalebar(x.min=-155.314, x.max=-155.311, y.min=19.818, y.max=19.824, dist=100, 
               dist_unit="m", transform=TRUE,
              st.bottom=FALSE, st.size=2, box.fill=c("gray50", "white"), model="WGS84",st.color="white", border.size=0.5)


##########
# Site plots: KP or RK only
##########
KP<- HAK.gps[(HAK.gps$Site=="KP"),]
RK<- HAK.gps[(HAK.gps$Site=="RK"),]

####### KP map
KP.gps<-c(-155.3189, lat=19.8219)
mapKP<-get_map(KP.gps,
              zoom=19, 
              scale = 2, 
              maptype= "satellite",
              source="google", extent= "device", legend="topright")

KP.map<-ggmap(mapKP, group=type)+
  geom_point(aes(x=longitude, y=latitude, shape=type, color=type), data=KP, alpha=0.8, size=2.5)+
  scale_y_continuous(limits=c(19.82165, 19.82225))+
  scale_x_continuous(limits=c(-155.3194, -155.3183)) +
  theme(legend.position="top",
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    legend.key = element_rect(fill = "white"),
    plot.margin = unit(c(0, 0.5, 0, 0), "cm"),
    text = element_text(size=8)) +
  guides(colour= guide_legend(override.aes = list(color = "white"))) +
  scale_color_manual(values=c('red','mediumseagreen'))+
  labs(x="Longitude", y="Latitude") +
  annotate("text", x=-155.31923, y=19.82225, label= "Koa Plantation (KP)", size=2.5, col="white")+
  ggsn::scalebar(x.min=-155.3183, x.max=-155.3187, y.min=19.82165, y.max=19.82225, dist=10, 
               dist_unit="m", transform=TRUE,
              st.bottom=FALSE, st.size=2, box.fill=c("gray50", "white"), model="WGS84", st.color="white", border.size=0.5)


####### RK map
RK.edit<-RK[-12,] # remove "proximate" Koa
RK.edit[9,3]<-"koa" # rename to be "koa"

RK.gps<-c(-155.315, 19.8216)
mapRK<-get_map(RK.gps,
               zoom=19, 
               scale = 2, 
               maptype= "satellite",
               source="google", extent= "device", legend="topright")

RK.map<-ggmap(mapRK, group=type)+
  geom_point(aes(x=longitude, y=latitude, shape=type, color=type), data=RK.edit, alpha=0.8, size=2.5)+
  scale_color_manual(values=c('red','mediumseagreen', "dodgerblue"))+
  scale_shape_manual(values=c(16, 17, 3)) +
  scale_y_continuous(limits=c(19.82120, 19.82195))+
  scale_x_continuous(limits=c(-155.31575, -155.3144)) +
  theme(legend.position="top",
        legend.title=element_blank(), 
        legend.key = element_rect(fill = "white"),
        plot.margin = unit(c(0, 0.5, 0, 0), "cm"), 
        text = element_text(size=8)) +
  labs(x="Longitude", y="") +
  annotate("text", x=-155.31555, y=19.821925, label= "Remnant Forest (RK)", size=2.5, col="white")+
  ggsn::scalebar(x.min=-155.3148, x.max=-155.3144, y.min=19.8212, y.max=19.8219, dist=10, 
               dist_unit="m", transform=TRUE,
              st.bottom=FALSE, st.size=2, box.fill=c("gray50", "white"), model="WGS84", st.color="white", border.size=0.5)


site.plots1<-plot_grid(hi_map_for_man, Hakalau.site, 
          labels=c('A', 'B'), label_size=8, hjust=-1, vjust= 6, ncol=2, nrow=1)

site.plots2<-plot_grid(KP.map, RK.map, 
          labels=c('C', 'D'), label_size=8, hjust=-1, vjust= 6, ncol=2, nrow=1)

site.compiled<-plot_grid(site.plots1, site.plots2, 
          ncol=1, nrow=2)


### export it
pdf(file= "figures/Fig 1.sitemaps.pdf", height=5, width=8)
site.compiled
dev.off()

```

#### Ecology and Isotopes data  
- DBH calculations  
- data mutating  
```{r, HKP data, fig.show=FALSE}
HAK.df<-read.csv("data/Hakalau.rawdata.csv")
cols<-c("Plot", "Sample", "ID") # columns to make factors
HAK.df[cols] <- lapply(HAK.df[cols], factor) # make all these factors

########## DBH 
DBH.df<- HAK.df %>%
  select(c(DBH..cm.1, DBH..cm.2, DBH..cm.3, DBH..cm.4, DBH..cm.5))

# all.dbh
all.dbh<-DBH.df

# make a plot factor
all.dbh$Plot<-HAK.df$Plot 

# remove unwanted NA rows
all.dbh<-all.dbh[c(1:28),]

# unlist to make into single y (all dbh) and the plots
box.DBH<-data.frame(y=unlist(all.dbh[1:5]), x=all.dbh$Plot)

colnames(box.DBH)<-c("dbh", "Plot")

#### box plot of individual trunks
indiv.trunk.dbh<-ggplot(box.DBH, aes(y=dbh, x=Plot, fill=Plot)) + 
  geom_boxplot(outlier.shape = NA)+
  geom_point(pch = 21, position = position_jitterdodge(), alpha=0.6) +
  xlab("Plots") +
  ylab("individual trunk dbh (cm)")+
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  theme_classic()

single.dbh.m<-aggregate(dbh~Plot, data=box.DBH, mean) # 20.8 (KP), 19.5 (RK) 
single.dbh.sd<-aggregate(dbh~Plot, data=box.DBH, sd) # 8.4 (KP), 14.2 (RK)


indiv.trunk.dbh   

dev.copy(pdf, "figures/notused/indiv.trunk.dbh.pdf", width=4, height=4, encod="MacRoman")
dev.off()

#################
  


####################
########################################
####################
  
# replace NAs with zeros
DBH.df<- DBH.df %>%
  mutate_each(funs(replace(., which(is.na(.)), 0)))

# if only one trunk, then make new column and report this value
DBH.df <- DBH.df %>%
  mutate(DBH.1trunk = ifelse(DBH..cm.2>"0", 0, DBH..cm.1))

# if multiple trunks, sum of squares and square root all trunks
# and plug in the DBH for single trunks
DBH.df <- DBH.df %>%
  mutate(DBH.Total = ifelse(DBH.1trunk=="0",  
                     sqrt(DBH..cm.1^2 + DBH..cm.2^2 + DBH..cm.3^2 + DBH..cm.4^2 + DBH..cm.5^2), DBH.1trunk))

# replace zeros with NA now that total DBH has been calculated
DBH.df$DBH.Total<-as.numeric(ifelse(DBH.df$DBH.Total=="0", "NA", DBH.df$DBH.Total))

############ Canopy diameter
# use area of an elipse, a x b x π, where a and b are major and minor radius
Can.df<-HAK.df %>%
  select(c(canopy.0..m, canopy.90..m, canopy.180..m, canopy.270..m))

# Major radius is the average of 0 and 180 degrees
Can.df<- Can.df %>% 
  mutate(Maj.rad = rowMeans(cbind(canopy.0..m, canopy.180..m), na.rm=T))

# Minor radius is the average of 90 and 270 degrees
Can.df<- Can.df %>% 
  mutate(Min.rad = rowMeans(cbind(canopy.90..m, canopy.270..m), na.rm=T))

# Elipse area
Can.df<- Can.df %>% 
  mutate(Canopy.area = ifelse(Maj.rad>0, Maj.rad*Min.rad*3.14, "NA"))

########################
# combine DBH.Total and Canopy.area with isotope dataframe and reduce columns
HAK.df$DBH.Total<-DBH.df$DBH.Total
HAK.df$Canopy.area<-Can.df$Canopy.area

# HAK.data is the full dataframe
HAK.data<- HAK.df %>%
  select(c(Plot, Position.point, Sample, DBH.Total, Canopy.area, d15N, d13C, N..percent, Total.N..mmol.gdw, C..percent, Total.C..mmol.gdw, C.N))

write.csv(HAK.data, "data/Hakalau.fulldata.csv")

```
  
#### Rubus and Koa relationship  
- plotting the relationship between Rubus and Koa d15N  
- took average of 3 closest Koa trees to each Rubus plant  
- plot Rubus d15N against Koa d15N (mean of 3 trees)  

```{r rubus and koa, fig.cap="Figure 2a. Relationship between d15N-Koa and 15N-Rubus at two sampling sites.", fig.align='center', results='hide'}
Ndfa<-read.csv("data/Ndfa.Rub.csv")

# rename the d15N so we know it is for rubus
Ndfa$d15N.Rub<-Ndfa$d15N
Ndfa$d15N.Koa<-Ndfa$mean.d15N.Ndfa

####################
## analysis of variance
Ndfa.mod1<-lm(d15N.Rub~d15N.Koa*Plot, data=Ndfa) # full model

Anova(Ndfa.mod1, type=2)
plot(allEffects(Ndfa.mod1), par.strip.text=list(cex=0.6))

#################### relationship between koa and rubus d15N?
# Yes, but a bit stronger in the RK site

mod.KP<-lm(Ndfa[(Ndfa$Plot=="KP"),]$d15N.Rub~Ndfa[(Ndfa$Plot=="KP"),]$d15N.Koa); anova(mod.KP)
summary(mod.KP)
int.rubKP<-coef(summary(mod.KP))[1] #intercept
slop.rubKP<-coef(summary(mod.KP))[2] #slope
                                  
mod.RK<-lm(Ndfa[(Ndfa$Plot=="RK"),]$d15N.Rub~Ndfa[(Ndfa$Plot=="RK"),]$d15N.Koa); anova(mod.RK)
summary(mod.RK)
int.RKoa<-coef(summary(mod.RK))[1] #intercept
slop.RKoa<-coef(summary(mod.RK))[2] #slope

## ranges
# RK Koa and Rubus
(max(Ndfa[(Ndfa$Plot=="RK"),]$d15N.Koa)-min(Ndfa[(Ndfa$Plot=="RK"),]$d15N.Koa))
(max(Ndfa[(Ndfa$Plot=="RK"),]$d15N.Rub)-min(Ndfa[(Ndfa$Plot=="RK"),]$d15N.Rub))

# KP Koa and Rubus
(max(Ndfa[(Ndfa$Plot=="KP"),]$d15N.Koa)-min(Ndfa[(Ndfa$Plot=="KP"),]$d15N.Koa))
(max(Ndfa[(Ndfa$Plot=="KP"),]$d15N.Rub)-min(Ndfa[(Ndfa$Plot=="KP"),]$d15N.Rub))


#### plot
BW.back<-theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black", size=0.2))

Rub.Koa.d15N.plot<-ggplot(data=Ndfa, aes(x=d15N.Koa, y=d15N.Rub, color=Plot))+
  geom_point(aes(color=Plot), alpha=.8) + 
  scale_color_manual(values=c("#E69F00", "#56B4E9")) +
  coord_equal() + theme_bw() +
  xlab(expression(paste(italic("Acacia koa "), delta^{15}, N, " (\u2030)"), sep=""))+
  ylab(expression(paste(italic("Rubus"), " spp. ", delta^{15}, N, " (\u2030)"), sep="")) +
  guides(colour=guide_legend(override.aes = list(stroke=1, fill="NA", alpha=1))) +
  geom_smooth(method = "lm", alpha = .15, size=0.6) +
  theme(legend.title = element_blank(),
        axis.text=element_text(size=6),
        axis.title=element_text(size=10),
        legend.position = c(0.85, 0.94), legend.key.size = unit(0.4, "cm"),
        legend.text = element_text(size = 8), legend.background=element_blank()) +
  annotate(geom="text", x=2.45, y=0.8, 
           label=expression(paste("KP:  R"^{2},"= 0.27, ",italic("p"), "=0.056")), size=2) +
  annotate(geom="text", x=2.45, y=0.6, 
           label=expression(paste("RK:  R"^{2},"= 0.26, ",italic("p="), bold("0.006"))), size=2) +
  BW.back

Rub.Koa.d15N.plot
dev.copy(pdf, "figures/Fig 3.Koa.Rub.regr.pdf", width=4, height=4, encod="MacRoman")
dev.off()

```
  

#### DBH, Canopy  d15N models  

With Plot being most important effect, divide DBH and Canopy to be plot mean +/- SE  
*Supplemental Figure 1. with afforested and remnant forests*   
- DBH and Canopy figure as bar chart and means
- using Mann-Whitney nonparametric tests: significant plot effects
- greater DBH (KP), trend for greater Canopy (RK)  
  
```{r DBH and Canopy, fig.show='hide'}
# Mann-Whitney U-Test
mwu(HAK.data, DBH.Total, Plot) # signif
mwu(HAK.data, Canopy.area, Plot) # not
```

box-plot scatter for DBH and Canopy area
```{r DBH and Canopy scatter, Fig.cap="Supplementary Figure 1.  Multi-trunk and individual diameter at breast height (DBH) and *A. koa* canopy area for two afforested and remnant forest plots.", fig.align='center', results='hide'}
##### alternative plots

multi.trunk.box<-ggplot(HAK.data, aes(x=Plot, y=DBH.Total, fill=Plot)) + 
  geom_boxplot(outlier.shape = NA, alpha=0.6)+
  geom_point(pch = 21, position = position_jitterdodge(), alpha=0.6) +
  xlab("Plots") +
  ylab("dbh (cm)") +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  annotate(geom="text", x=1.55, y=50, label=expression(paste(bold("*"))), size=5) +
  theme_classic()


canopy.box<-ggplot(HAK.data, aes(x=Plot, y=Canopy.area, fill=Plot)) + 
  geom_boxplot(outlier.shape = NA, alpha=0.6)+
  geom_point(pch = 21, position = position_jitterdodge(), alpha=0.6) +
  xlab("Plots") +
  ylab(expression(paste("Canopy (m"^2,")"))) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  theme_classic()

# get the legend, # create some space to the left of the legend
box.legend <- get_legend(
  multi.trunk.box + 
    theme(legend.box.margin = margin(0, 0, 0, 12)) +
    theme(legend.title=element_blank())+ # no need for a title above legend
    theme(legend.key.size = unit(0.5, "cm")))

#  figures together
alt_dbh.canopy<-plot_grid(plot_grid(multi.trunk.box + theme(legend.position = "none"), 
                     canopy.box + theme(legend.position = "none"),
                     box.legend,
                     nrow=1, ncol=3, labels=c('A', 'B'), 
          label_size=8, hjust=-1, vjust= 3, rel_widths = c(8, 8, 3)))


alt_dbh.canopy       
dev.copy(pdf, "figures/FigS1.DBHCanopy.pdf", width=6, height=3.5, encod="MacRoman")
dev.off()
```

```{r DBH based age, Fig.cap="Supplementary Figure x. DBH-estimates of *A. koa* age in afforested and remnant forest plots.", fig.align='center', results='hide'}
###################### age
# approx age

HAK.data<-HAK.data %>%
  mutate(growth.rate.mm.y = ifelse(Plot=="KP" & Sample=="Koa", 12,
         ifelse(Plot=="RK" & Sample=="Koa", 4, "NA")))

HAK.data$growth.rate.mm.y<-as.numeric(HAK.data$growth.rate.mm.y)

HAK.data<-HAK.data %>%
  mutate(alt.age = ifelse(Sample=="Koa", (DBH.Total*10)/growth.rate.mm.y, "NA"))
# correct for DBH being in cm and not mm

HAK.data$alt.age<-as.numeric(HAK.data$alt.age)

#### box plot of mutli-trunks, at 7 mm/y
multi.trunk.altage<-ggplot(HAK.data, aes(y=alt.age, x=Plot, fill=Plot)) + 
  geom_boxplot(outlier.shape = NA, alpha=0.6)+
  geom_point(pch = 21, position = position_jitterdodge(), alpha=0.6) +
  xlab("Plots") +
  ylab("age estimate (year)")+
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  annotate(geom="text", x=1.55, y=75, label=expression(paste(bold("*"))), size=5) +
  theme_classic()

multi.trunk.altage 
dev.copy(pdf, "figures/notused/Fig.Sx.multi.trunk.age.pdf", width=4, height=4, encod="MacRoman")
dev.off()

# get some info on the means
age.m<-aggregate(alt.age~Plot, data=HAK.data, mean)
age.sd<-aggregate(alt.age~Plot, data=HAK.data, sd)
age.n<-aggregate(alt.age~Plot, data=HAK.data, length)

```
  
Run statistics on the responses (dd15N, 13C, tissue C and N)
```{r, stats on responses, results='hide', fig.show='hide'}

# models

# make a factor for "plants" or "soil"
HAK.data<-HAK.data %>%
  mutate(Soil.or.plant = ifelse(Sample=="Soil", "Soil", "Plants"))

HAK.data<-HAK.data %>%
  mutate(Sample.Type = ifelse(Sample=="Koa", "Koa",
                             ifelse(Sample=="Soil", "Soil",
                                    "Rubus spp")))

HAK.data$Soil.or.plant<-as.factor(HAK.data$Soil.or.plant)
HAK.data$Sample.Type<-as.factor(HAK.data$Sample.Type)


## tests for assumptions
for(i in c(6:12)){
  Y<-HAK.data[,i]
  full<-lm(Y~Sample.Type*Plot, data=HAK.data, na.action=na.exclude)
  R <- resid(full) #save glm residuals
 
  op<-par(mfrow = c(2,3), mar=c(5,4,1,2), pty="sq")
  plot(full, add.smooth = FALSE, which=1)
  QQ <- qqnorm(R, main = colnames(HAK.data)[i]) 
  QQline <- qqline(R)
  hist(R, xlab="Residuals", main = colnames(HAK.data)[i])
  plot(HAK.data$Plot, R, xlab=colnames(HAK.data)[i], ylab="Residuals")
  plot(HAK.data$Sample.Type, R, xlab=colnames(HAK.data)[i], ylab="Residuals")
}

########## Separate dataframes
# only KP (or RK) and only plants in those sites
KP.df<-HAK.data[(HAK.data$Plot=="KP"),]; KP.df.plants<-KP.df[(KP.df$Soil.or.plant=="Plants"),]
RK.df<-HAK.data[(HAK.data$Plot=="RK"),]; RK.df.plants<-RK.df[(RK.df$Soil.or.plant=="Plants"),]

```
  
**d15N models**
```{r, d15N, fig.show='hide'}
######## Nitrogen isotopes
d15N.mod<-lm(d15N~Sample.Type*Plot, data=HAK.data); anova(d15N.mod) # plants Type and Plot signif.
plot(allEffects(d15N.mod))

# no interaction
Anova(d15N.mod, type=2)
posthoc<-emmeans(d15N.mod, ~Plot|Sample.Type)
pairs(posthoc)
multcomp::cld(posthoc, Letters=letters)

# Rubus vs. koa in each forest, plants only
d15N.mod.KP<-lm(d15N~Sample.Type, data=KP.df.plants); anova(d15N.mod.KP) # Rubus and Koa diff signif.
plot(allEffects(d15N.mod.KP))

d15N.mod.RK<-lm(d15N~Sample.Type, data=RK.df.plants); anova(d15N.mod.RK) # Rubus and Koa diff signif.
plot(allEffects(d15N.mod.RK))

```
  
**d13C models**
```{r, d13C, fig.show='hide'}
######## ######## 
######## Carbon isotopes
d13C.mod<-lm(d13C~Sample.Type*Plot, data=HAK.data); anova(d13C.mod) # plants signif.

# no interaction
Anova(d13C.mod, type=2)
posthoc<-emmeans(d13C.mod, ~Plot|Sample.Type)
pairs(posthoc)
multcomp::cld(posthoc, Letters=letters)

# Rubus vs. koa in each forest, plants only
d13C.mod.KP<-lm(d13C~Sample.Type, data=KP.df.plants); anova(d13C.mod.KP) # Rubus and Koa NOT diff
plot(allEffects(d13C.mod.KP))

d13C.mod.RK<-lm(d13C~Sample.Type, data=RK.df.plants); anova(d13C.mod.RK) # Rubus and Koa NOT diff
plot(allEffects(d13C.mod.RK))
```
 
**Nitrogen content models**
```{r, N content, fig.show='hide'}
####### Nitrogen content
TN.mod<-lm(Total.N..mmol.gdw~Sample.Type*Plot, data=HAK.data); anova(TN.mod) # plants signif.
plot(allEffects(TN.mod))

Anova(TN.mod, Type=2)
posthoc<-emmeans(TN.mod, ~Sample.Type)
multcomp::cld(posthoc, Letters=letters)

# Rubus vs. koa in each forest, plants only
TN.mod.KP<-lm(Total.N..mmol.gdw~Sample.Type, data=KP.df.plants); anova(TN.mod.KP) # Rubus and Koa diff
plot(allEffects(TN.mod.KP))

TN.mod.RK<-lm(Total.N..mmol.gdw~Sample.Type, data=RK.df.plants); anova(TN.mod.RK) # Rubus and Koa almost diff
plot(allEffects(TN.mod.RK))
```
 
**Carbon content models**
```{r, C content, fig.show='hide'}
######## ######## 
######## Carbon content
TC.mod<-lm(Total.C..mmol.gdw~Sample.Type*Plot, data=HAK.data); anova(TC.mod) # plants signif.
plot(allEffects(TC.mod))

Anova(TC.mod, Type=2)
posthoc<-emmeans(TC.mod, ~Plot|Sample.Type)
pairs(posthoc)
multcomp::cld(posthoc, Letters=letters)

# Rubus vs. koa in each forest, plants only
TC.mod.KP<-lm(Total.C..mmol.gdw~Sample.Type, data=KP.df.plants); anova(TC.mod.KP) # Rubus and Koa NOT diff
plot(allEffects(TC.mod.KP))

TC.mod.RK<-lm(Total.C..mmol.gdw~Sample.Type, data=RK.df.plants); anova(TC.mod.RK) # Rubus and Koa NOT diff
plot(allEffects(TC.mod.RK))

```
  
**C:N models**
```{r, CN values, fig.show='hide'}
####### C:N content
CN.mod<-lm(C.N~Sample.Type*Plot, data=HAK.data); anova(CN.mod) # plants signif.
plot(allEffects(TC.mod))

Anova(CN.mod, Type=2)
posthoc<-emmeans(CN.mod, ~Sample.Type)
pairs(posthoc)
multcomp::cld(posthoc, Letters=letters)

```

*Figure 2*   
data means and SE for plots  
- bar plots of d13C, d15N, TC and TN for all 4 samples types with asterisks for significant effects

```{r, plots of isotope data, Fig.cap="Supplementary Figure 2. Mean +/- SE of sample (a) d13C, (b) d15N, (c) total carbon, and (d) total nitrogen.", fig.align='center', message=FALSE, results='hide'}
## make some means and SE
d13C.m<-aggregate(d13C~Plot+Sample, data=HAK.data, mean)
d15N.m<-aggregate(d15N~Plot+Sample, data=HAK.data, mean)
TN.m<-aggregate(Total.N..mmol.gdw~Plot+Sample, data=HAK.data, mean)
TC.m<-aggregate(Total.C..mmol.gdw~Plot+Sample, data=HAK.data, mean)
CN.m<-aggregate(C.N~Plot+Sample, data=HAK.data, mean)

d13C.SE<-aggregate(d13C~Plot+Sample, data=HAK.data, std.error)
d15N.SE<-aggregate(d15N~Plot+Sample, data=HAK.data, std.error)
TN.SE<-aggregate(Total.N..mmol.gdw~Plot+Sample, data=HAK.data, std.error)
TC.SE<-aggregate(Total.C..mmol.gdw~Plot+Sample, data=HAK.data, std.error)
CN.SE<-aggregate(C.N~Plot+Sample, data=HAK.data, std.error)

d13C.n<-aggregate(d13C~Plot+Sample, data=HAK.data, length)
d15N.n<-aggregate(d15N~Plot+Sample, data=HAK.data, length)

mean.data<- cbind(d13C.m, d15N.m[3], TN.m[3], TC.m[3], d13C.SE[3], d15N.SE[3], TN.SE[3], TC.SE[3], CN.m[3], CN.SE[3])
colnames(mean.data)<-c("Plot", "Sample", "d13C.mean", "d15N.mean", "TN.mean", "TC.mean", "d15N.SE", "d13C.SE", "TN.SE", "TC.SE", "CN.mean", "CN.SE")

# rename Rubus species for plotting
levels(mean.data$Sample)[levels(mean.data$Sample)=="RUBARG"] <- "Rubus spp"
levels(mean.data$Sample)[levels(mean.data$Sample)=="RUBHAW"] <- "Rubus spp"

mean.data$Sample<-factor(mean.data$Sample, levels=c("Soil", "Koa", "Rubus spp"))

### make mean plots
pd <- position_dodge(0.7) #offset for error bars

### d13C
d13C.plot<-ggplot(data=mean.data, aes(x=Sample, y=d13C.mean, fill=Plot, group=Plot))+
  geom_bar(stat="identity", position = pd, width=0.7, alpha=0.5)+
  geom_errorbar(aes(ymin=d13C.mean-d13C.SE, ymax=d13C.mean+d13C.SE), size=.3, width=0, position=pd) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  scale_x_discrete(labels=expression(Soil, italic(A.~koa),italic(Rubus)~spp.))+
  annotate(geom="text", x=1, y=-27.5, label=expression(paste(bold("*"))), size=4) +
  annotate(geom="text", x=2, y=-33, label=expression(paste(bold("*"))), size=4) +
  annotate(geom="text", x=3, y=-33, label=expression(paste(bold("*"))), size=4) +
  theme(text = element_text(size=8)) +
  ylab(expression(paste(delta^{13}, C, " (\u2030, V-PDB)"))) + BW.back

### d15N
d15N.plot<-ggplot(data=mean.data, aes(x=Sample, y=d15N.mean, fill=Plot, group=Plot))+
  geom_bar(stat="identity", position = pd, width=0.7, alpha=0.5) + ylim(c(0,8)) +
  geom_errorbar(aes(ymin=d15N.mean-d15N.SE, ymax=d15N.mean+d15N.SE), size=.3, width=0, position=pd) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  scale_x_discrete(labels=expression(Soil, italic(A.~koa),italic(Rubus)~spp.))+
  theme(text = element_text(size=8)) +
  annotate(geom="text", x=2, y=2.8, label=expression(paste(bold("*"))), size=4) +
  annotate(geom="text", x=3, y=3.3, label=expression(paste(bold("*"))), size=4) +
  ylab(expression(paste(delta^{15}, N, " (\u2030, air)"))) + BW.back

### total Carbon
TC.plot<-ggplot(data=mean.data, aes(x=Sample, y=TC.mean, fill=Plot, group=Plot))+
  geom_bar(stat="identity", position = pd, width=0.7, alpha=0.5)+ ylim(c(0, 60)) +
  geom_errorbar(aes(ymin=TC.mean-TC.SE, ymax=TC.mean+TC.SE), size=.3, width=0, position=pd) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  scale_x_discrete(labels=expression(Soil, italic(A.~koa),italic(Rubus)~spp.))+
  theme(text = element_text(size=8),
        legend.position = c(0.9, 0.9), legend.key.size = unit(0.3, "cm"),
        legend.title = element_blank()) +
  annotate(geom="text", x=1, y=25, label=expression(paste(bold("*"))), size=4) +
  annotate(geom="text", x=3, y=42, label=expression(paste(bold("*"))), size=4) +
  ylab("Total Carbon (mmol/gdw)") +  BW.back 

### total Nitrogen
TN.plot<-ggplot(data=mean.data, aes(x=Sample, y=TN.mean, fill=Plot, group=Plot))+
  geom_bar(stat="identity", position = pd, width=0.7, alpha=0.5)+
  geom_errorbar(aes(ymin=TN.mean-TN.SE, ymax=TN.mean+TN.SE), size=.3, width=0, position=pd) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  scale_x_discrete(labels=expression(Soil, italic(A.~koa),italic(Rubus)~spp.))+
  theme(text = element_text(size=8)) +
  ylab("Total Nitrogen (mmol/gdw)") + BW.back

# get the legend, # create some space to the left of the legend
bar.legend <- get_legend(
  TN.plot + 
    theme(legend.box.margin = margin(0, 0, 0, 12)) +
    theme(legend.title=element_blank())+ # no need for a title above legend
    theme(legend.key.size = unit(0.3, "cm")))

#  figures together
bar.plots<-plot_grid(d15N.plot + theme(legend.position = "none"), 
                     d13C.plot + theme(legend.position = "none"),
                     TN.plot + theme(legend.position = "none"),
                     TC.plot,
                     nrow=1, ncol=4, labels=c('A', 'B', 'C', 'D'), 
          label_size=8, hjust=-1, vjust= 3)

#plot_grid(bar.plots, bar.legend, rel_widths = c(8, 1)) # legend  1/8 size as first obj.
bar.plots
dev.copy(pdf, "figures/Fig 2.mean.data.sample.pdf", width=7.5, height=3, encod="MacRoman")
dev.off()
```
  
### ISO-KRIG
Give the data a "krig-over".  
  
First, make krigs of the full plot and all data layers
```{r, krig setup, message=FALSE, results='hide'}
# load data
krig<-read.csv("data/krig.matrix.csv") # matrix of points for isoscape grid


# merge kriging data with isotope data
data.merge<-as.data.frame(join_all(list(HAK.data, krig), by = "Position.point", type='full'))

data.merge<-data.merge[c(-167:-194),] # drop NAs where no samples taken
scape.data<-data.merge

write.csv(scape.data, "output/scape.data.csv")
#################
```

### Isoscapes
setup a map for the points 
```{r, krig d15N, message=FALSE, results='hide', fig.show='hide'}

################# make site maps based on bubble plots
# just KP site
krig.KP<- scape.data %>% filter(Plot=="KP")
krig.KP$Sample<-droplevels(krig.KP$Sample)

# modify one point slightly due to overlap of coordinate system
krig.KP$y.matrix[24]=2.4; krig.KP$y.meter[24]=2.4
krig.KP$x.matrix[24]=5.4; krig.KP$x.meter[24]=5.4

# dot plot, sized by d15N values in KP
KP.map<-krig.KP %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + geom_point(aes(size=d15N, color=Sample), alpha=3/4) + 
  ggtitle("KP plot--d15N (permil)") + coord_equal() + theme_bw()



##### just RK site
krig.RK<- scape.data %>% filter(Plot=="RK")
krig.RK$Sample<-droplevels(krig.RK$Sample)

# dot plot, sized by d15N values in RK
RK.map<-krig.RK %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + geom_point(aes(size=d15N, color=Sample), alpha=3/4) +
  ggtitle("RK plot--d15N (permil)") + coord_equal() + theme_bw()

plot_grid(RK.map, KP.map, ncol=2, nrow=1)

#####################
#####################


######## dotplot for annotating with notes, this is supplemental figure
### not sized by values
KP.map2<-krig.KP %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + 
  geom_point(aes(shape = Sample, color=Sample), size=3, alpha=3/4) + 
  scale_shape_manual(values=c(17,15,16)) +
  scale_color_manual(values=c("mediumseagreen","lightskyblue3", "peru")) +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 4)) +
  scale_x_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  ggtitle("KP plot") + coord_equal() + theme_bw()


RK.map2<-krig.RK %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + 
  geom_point(aes(shape = Sample, color=Sample), size=3, alpha=3/4) + 
  scale_shape_manual(values=c(17,15,16)) +
  scale_color_manual(values=c("mediumseagreen", "lightskyblue3", "peru")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  scale_x_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 4)) +
  ggtitle("RK plot") + coord_equal() + theme_bw()


# export individual maps to edit
plot_grid(RK.map2, ncol=1, nrow=1)
dev.copy(pdf, "figures/notused/RK.map.dotplot.pdf", width=5, height=9, encod="MacRoman")
dev.off()

plot_grid(KP.map2, ncol=1, nrow=1)
dev.copy(pdf, "figures/notused/KP.map.dotplot.pdf", width=7, height=4, encod="MacRoman")
dev.off()

#####################
#####################
```
  
```{r, pooled sample isoscapes, eval=FALSE}

#### this was not kept due to the high varibility in samples and the lack of insight provided relative to the single sample type (soil or foliar).



#First generate an isoscape for the compelte pooled sample set: the soil, koa, and *Rubus*. Do this for each of the two forests.  Figure 4ab
  
#*Acacia koa* plantation (KP) pooled δ^15^N isoscape

# autokrige
set.seed(100)
d15N.KP.auto <- autoKrige(d15N ~ 1, krig.KP, Grid.KP) # ordinary kriging
plot(d15N.KP.auto, sp.layout = list(pts = list("sp.points", krig.KP)))
dev.copy(pdf, "figures/notused/KP_15N_pooled_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d15N.KP.auto$krige_output

#####
# Moran's I for autocorrelation
coord.pool.KP<-cbind(krig.KP$x.matrix, krig.KP$y.matrix)
res.pool.KP.N<-as.data.frame(pgirmess::correlog(coord.pool.KP, krig.KP$d15N, method="Moran"))

moran.pool.KP.d15N<-ggplot(res.pool.KP.N, aes(x=dist.class, y=coef)) +
  geom_smooth() +
  geom_point(size=2, pch=21) +
  ggtitle("KP: Soil+foliar d15N") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

####### other approach for Moran

nb<-tri2nb(coord.pool.KP,row.names=NULL)
moran.test(krig.KP$d15N, nb2listw(nb))

d15N.kp.spline<- spline.correlog(x=krig.KP$x.matrix, y=krig.KP$y.matrix,
                         z=krig.KP$d15N, resamp=100, xmax=10)
plot(d15N.kp.spline,text=TRUE)


# make to dataframes for lm, combine
KP.pred.N <- d15N.KP.auto[1] %>% as.data.frame() # model predictions
KP.df.N <- krig.KP %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.KP.df.N<- left_join(KP.df.N, KP.pred.N, by = c("x.meter"="krige_output.x")) # longest axis is x
mod <- lm(krige_output.var1.pred ~ d15N, data=pred.KP.df.N)
summary(mod) #R squared = 0.21

mean(pred.KP.df.N$krige_output.var1.pred, na.rm=T) # mean of predictions 4.4 d15N
mean(pred.KP.df.N$krige_output.var1.stdev, na.rm=T) # 2.1

# inspect model
# plot(pred.KP.df.N$krige_output.var1.pred ~ pred.KP.df.N$d15N, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")

### map in automap
#automapPlot(d15N.KP.auto$krige_output, "var1.pred", sp.layout = list("sp.points", krig.KP, pch=16, col="gray20", cex=0.5), col.regions=my.palette)

# map in ssplot
# note that the prediction "var1.pred" component of the krig is a SpatialPixelsDataFrame. Need to call the krig, then the component df("krige_output"), then the output column ("var1.pred") to plot in spplot

# variance
# spplot(d15N.KP.auto$krige_output,"var1.stdev")

#predicted krige
my.palette2 <- brewer.pal(n = 6, name = "BuGn")
my.palette3 <- colorRampPalette(c("firebrick1", "darkseagreen1", "azure1"))(4)
col.scheme.N <- colorRampPalette(my.palette3)


plotd15N.krig.KP<-spplot(d15N.KP.auto$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{15}, N, " - KP (Restored Forest)")), cex=0.8), colorkey=FALSE)


###########################



#Remnant Forest (RK) pooled δ^15^N isoscape

###########################
# RK Site Krig
###########################
## Krig RK site 
krig.RK<- scape.data %>% filter(Plot=="RK")
krig.RK$Sample<-droplevels(krig.RK$Sample)

coordinates(krig.RK)<- ~x.meter + y.meter

Columns=seq(from=-1, to=21, by=0.05)
Rows=seq(from=-1, to=36, by=0.05)
Grid.RK <- expand.grid(x=Columns,y=Rows)
coordinates(Grid.RK) <- ~ x+y
gridded(Grid.RK) <- TRUE # Plot the grid and points

## expand binding box 
#krig.RK@bbox # current data binding box
x<-c(-1, 21)
y<-c(-1, 36)
xy<-cbind(x,y)
S<-SpatialPoints(xy)
bbox(S)
Grid.RK@bbox<-bbox(S) # expand for plot corner

# autokrige
# 'fix.values' = The items describe the fixed value for the nugget (y-intercept), range (of interprolation) and sill(asymptote) respectively. Setting the value to NA means that the value is not fixed. Is passed on to autofitVariogram.
# The nugget is the y-intercept of the variogram. In practical terms, the nugget represents the small-scale variability of the data. A portion of that short range variability can be the result of measurement error. 
# The range is the distance after which the variogram levels off. The physical meaning of the range is that pairs of points that are this distance or greater apart are not spatially correlated. 
# The sill is the total variance contribution, or the maximum variability between pairs of points. 

# increasing the range gave better fit than auto
set.seed(100)
d15N.RK.auto <- autoKrige(d15N ~ 1, krig.RK, Grid.RK)# fix.value=c(NA, 2, NA)) # ordinary kriging
plot(d15N.RK.auto, sp.layout = list(pts = list("sp.points", krig.RK)))
dev.copy(pdf, "figures/notused/RK_15N_pooled_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d15N.RK.auto$krige_output

# Moran's I for autocorrelation
coord.pool.RK<-cbind(krig.RK$x.matrix, krig.RK$y.matrix)
res.pool.RK.N<-as.data.frame(pgirmess::correlog(coord.pool.RK, krig.RK$d15N, method="Moran"))

moran.pool.RK.d15N<-ggplot(res.pool.RK.N, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("RK: Soil+foliar d15N") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

####### other approach
nb<-tri2nb(coord.pool.RK,row.names=NULL)
moran.test(krig.RK$d15N, nb2listw(nb))

d15N.rk.spline<- spline.correlog(x=krig.RK$x.matrix, y=krig.RK$y.matrix,
                         z=krig.RK$d15N, resamp=100, xmax=10)
plot(d15N.rk.spline, text=TRUE)
#####

# make to dataframes for lm, combine
RK.pred.N <- d15N.RK.auto[1] %>% as.data.frame() # model predictions
RK.df.N <- krig.RK %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
# longest axis here is y
pred.RK.df.N<- left_join(RK.df.N, RK.pred.N, by = c("x.meter"="krige_output.x"))
mod <- lm(krige_output.var1.pred ~ d15N, data=pred.RK.df.N)
summary(mod) #R squared = 0.21
mean(pred.RK.df.N$krige_output.var1.pred, na.rm=T) # mean of predictions 4.9 d15N
mean(pred.RK.df.N$krige_output.var1.stdev, na.rm=T) # 1.9

# inspect model
# plot(pred.RK.df.N$krige_output.var1.pred ~ pred.RK.df.N$d15N, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

#predicted krige
plotd15N.krig.RK<-spplot(d15N.RK.auto$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample], 
                        col="black", cex=0.8, alpha=0.5), 
       main=list(label=expression(paste(delta^{15}, N, " - RK (Remnant Forest)")), cex=0.7))


#combine the KP-RK d15N pooled isoscape

#####################
grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d15N plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(plotd15N.krig.KP, plotd15N.krig.RK, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/FigS2_ab.d15N.comb.isoscape.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()


#### δ^13^C pooled isoscape  
# setup

################# d13C krigs
################# make site maps based on bubble plots

KP.map<-krig.KP %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + geom_point(aes(size=d13C, color=Sample), alpha=3/4) + 
  ggtitle("KP plot--d13C (permil)") + coord_equal() + theme_bw()


RK.map<-krig.RK %>% as.data.frame %>% 
  ggplot(aes(x.meter, y.meter, group=Sample)) + geom_point(aes(size=d13C, color=Sample), alpha=3/4) +
  ggtitle("RK plot--d13C (permil)") + coord_equal() + theme_bw()




# *Acacia koa* plantation (KP) d13C isoscape

# autokrige
d13C.KP.auto <- autoKrige(d13C ~ 1, krig.KP, Grid.KP) # ordinary kriging
plot(d13C.KP.auto, sp.layout = list(pts = list("sp.points", krig.KP)))
dev.copy(pdf, "figures/notused/KP_13C_pooled_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d13C.KP.auto$krige_output

# Moran's I for autocorrelation
res.pool.KP.C<-as.data.frame(pgirmess::correlog(coord.pool.KP, krig.KP$d13C, method="Moran"))

moran.pool.KP.d13C<-ggplot(res.pool.KP.C, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("KP: Soil+foliar d13C") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

####### other approach
nb<-tri2nb(coord.pool.KP,row.names=NULL)
moran.test(krig.KP$d13C, nb2listw(nb))

d13C.kp.spline<- spline.correlog(x=krig.KP$x.matrix, y=krig.KP$y.matrix,
                         z=krig.KP$d13C, resamp=100, xmax=10)
plot(d13C.kp.spline, text=TRUE)
#####

# make to dataframes for lm, combine
KP.pred.C <- d13C.KP.auto[1] %>% as.data.frame() # model predictions
KP.df.C <- krig.KP %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.KP.df.C<- left_join(KP.df.C, KP.pred.C, by = c("x.meter"="krige_output.x")) # longest axis is x
mod <- lm(krige_output.var1.pred ~ d13C, data=pred.KP.df.C)
summary(mod) #R squared = 0.24

mean(pred.KP.df.C$krige_output.var1.pred, na.rm=T) # mean of predictions -25.9 d13C
mean(pred.KP.df.C$krige_output.var1.stdev, na.rm=T) # 2.3

# inspect model
# plot(pred.KP.df.C$krige_output.var1.pred ~ pred.KP.df.C$d13C, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")

# map in automap
#automapPlot(d13C.KP.auto$krige_output, "var1.pred", sp.layout = list("sp.points", krig.KP, pch=16, col="gray20", cex=0.5), col.regions=my.palette)

# map in ssplot
# variance
# spplot(d13C.KP.auto$krige_output,"var1.stdev")

#predicted krige
my.palette4 <- colorRampPalette(c("firebrick1", "paleturquoise2", "azure1"))(4)
col.scheme.C <- colorRampPalette(my.palette4)


plotd13C.krig.KP<-spplot(d13C.KP.auto$krige_output["var1.pred"], col.regions=col.scheme.C, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample],
                        col="black", cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{13}, C, " - KP (Restored Forest)")), cex=0.8), colorkey=FALSE)


## Remnant Forest (RK) d13C isoscape: Figure 2cd

###########################
# RK Site Krig
###########################
## Krig RK site 

# autokrige, with nugget, range and sill 
d13C.RK.auto <- autoKrige(d13C ~ 1, krig.RK, Grid.RK, fix.value=c(NA, 3, NA)) # ordinary kriging
plot(d13C.RK.auto, sp.layout = list(pts = list("sp.points", krig.RK)))
dev.copy(pdf, "figures/notused/RK_13C_pooled_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()

#d13C.RK.auto$krige_output

# Moran's I for autocorrelation
res.pool.RK.C<-as.data.frame(pgirmess::correlog(coord.pool.RK, krig.RK$d13C, method="Moran"))

moran.pool.RK.d13C<-ggplot(res.pool.RK.C, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("RK: Soil+foliar d13C") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()


# make to dataframes for lm, combine
RK.pred.C <- d13C.RK.auto[1] %>% as.data.frame() # model predictions
RK.df.C <- krig.RK %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
# longest axis here is y
pred.RK.df.C<- left_join(RK.df.C, RK.pred.C, by = c("x.meter"="krige_output.x"))
mod <- lm(krige_output.var1.pred ~ d13C, data=pred.RK.df.C)
summary(mod) #R squared = 0.33

mean(pred.RK.df.C$krige_output.var1.pred, na.rm=T) # mean of predictions -27.6 d13C
mean(pred.RK.df.C$krige_output.var1.stdev, na.rm=T) # 2.8

# inspect model
# plot(pred.RK.df.C$krige_output.var1.pred ~ pred.RK.df.C$d13C, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# map in automap
#automapPlot(d13C.RK.auto$krige_output, "var1.pred", sp.layout = list("sp.points", krig.RK), col.regions=my.palette)

# variance
# spplot(d13C.RK.auto$krige_output,"var1.stdev")

#predicted krige 
plotd13C.krig.RK<-spplot(d13C.RK.auto$krige_output["var1.pred"], col.regions=col.scheme.C, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample],
                        col="black", cex=0.8, alpha=0.5), 
       main=list(label=expression(paste(delta^{13}, C, " - RK (Remnant Forest)")), cex=0.7))


## combine the plots

#####################
grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d13C plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(plotd13C.krig.KP,plotd13C.krig.RK, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/FigS2_cd.d13C.comb.isoscape.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()



#### Density plots: pooled samples  

#Density plots using predictions of N and C values for all sample types: the soil, koa, and *Rubus*. 

###################
# make density plots using predictions
# combine the predictions for each plot
KP.df.out.N<-as.data.frame(KP.pred.N$krige_output.var1.pred); KP.df.out.N$Plot<-"KP"
RK.df.out.N<-as.data.frame(RK.pred.N$krige_output.var1.pred); RK.df.out.N$Plot<-"RK"; 
colnames(KP.df.out.N)<-c("d15N.pred", "Plot")
colnames(RK.df.out.N)<-c("d15N.pred", "Plot")

# new dataframe
pred.dat.N<-rbind(KP.df.out.N, RK.df.out.N)
pred.dat.N$Plot<-as.factor(pred.dat.N$Plot)
pred.dat.N %>% 
  group_by(Plot) %>%
  summarise(no_rows = length(Plot))

#man whitney for significance (not normal data)
# POOLED SAMPLE N
mwu(pred.dat.N, d15N.pred, Plot) # signif difference in predictions (p<0.001)

# Density plot

# plot.means
predict.mean.N <- ddply(pred.dat.N, "Plot", summarise, grp.mean=mean(d15N.pred, na.rm=TRUE))
predict.SD.N <- ddply(pred.dat.N, "Plot", summarise, sd=sd(d15N.pred, na.rm=TRUE))


density.predict.N.pooled<-ggplot(pred.dat.N, aes(x=d15N.pred)) +
  geom_density(aes(color=Plot, fill=Plot), alpha=0.5, lwd=0.4)+
  xlab(expression(paste("Soil+Foliar ",delta^{15}, N["predicted"], sp="")))+
  theme(axis.text = element_text(size = 6), axis.ticks = element_line(size = 0.2)) +
  ylab("density")+
  scale_y_continuous(labels = label_number(accuracy = 0.5))+
  scale_color_manual(values=c("#E69F00", "#56B4E9")) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  geom_vline(data=predict.mean.N, aes(xintercept=grp.mean, color=Plot),
             linetype="dashed", lwd=0.2) + BW.back
  #annotate(geom="text", x=0, y=3.3, label=expression(paste(bold("A"))), size=3) 


######## Carbon


###################
# make density plots using predictions
# combine the predictions for each plot
KP.df.out.C<-as.data.frame(KP.pred.C$krige_output.var1.pred); KP.df.out.C$Plot<-"KP"
RK.df.out.C<-as.data.frame(RK.pred.C$krige_output.var1.pred); RK.df.out.C$Plot<-"RK"; 
colnames(KP.df.out.C)<-c("d13C.pred", "Plot")
colnames(RK.df.out.C)<-c("d13C.pred", "Plot")

# new dataframe
pred.dat.C<-rbind(KP.df.out.C, RK.df.out.C)
pred.dat.C$Plot<-as.factor(pred.dat.C$Plot)
pred.dat.C %>% 
  group_by(Plot) %>%
  summarise(no_rows = length(Plot))

#man whitney for significance (not normal data)
# POOLED sample C
mwu(pred.dat.C, d13C.pred, Plot) # signif difference in predictions (p<0.001)

# Density plot
# plot.means
predict.mean.C <- ddply(pred.dat.C, "Plot", summarise, grp.mean=mean(d13C.pred, na.rm=TRUE))
predict.sd.C <- ddply(pred.dat.C, "Plot", summarise, sd=sd(d13C.pred, na.rm=TRUE))

density.predict.C.pooled<-ggplot(pred.dat.C, aes(x=d13C.pred)) +
  geom_density(aes(color=Plot, fill=Plot), alpha=0.5, lwd=0.4)+
  xlab(expression(paste("Soil+Foliar ", delta^{13}, C["predicted"], sp="")))+
  theme(axis.text = element_text(size = 6), axis.ticks = element_line(size = 0.2)) +
  ylab("")+
  scale_color_manual(values=c("#E69F00", "#56B4E9")) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  geom_vline(data=predict.mean.C, aes(xintercept=grp.mean, color=Plot),
             linetype="dashed", lwd=0.2) + BW.back 
  #annotate(geom="text", x=-32, y=1.7, label=expression(paste(bold("B"))), size=3)

# get the legend, # create some space to the left of the legend
density.legend <- get_legend(
  density.predict.C.pooled + #plot this one
    theme(legend.title=element_blank())+ # no need for a title above legend
    theme(legend.box.margin = margin(0, 0, 0, 12)) + #box margin
    theme(legend.key.size = unit(0.3, "cm"))) # legend size

gridExtra::grid.arrange(density.predict.N.pooled + theme(legend.position = "none"),
                        density.predict.C.pooled + theme(legend.position = "none"),
                        density.legend,
                        ncol=3, nrow=1, widths = c(1,1,0.4))
```
  
#### δ^15^N soil-isoscape
  
Subset data and only examine SOIL.     
*Restored forest (KP)* and *Remnant Forest (RK)*
```{r, KP soil krig, message=FALSE, results='hide'}
## Krig KP sites
coordinates(krig.KP)<- ~x.meter + y.meter

# Create a grid of "Pixels" using x as columns and y as rows
# And the rows and columns of pixels:
Columns=seq(from=-1, to=36, by=0.05)
Rows=seq(from=-1, to=21, by=0.05)
Grid.KP <- expand.grid(x=Columns,y=Rows)
coordinates(Grid.KP) <- ~ x+y
gridded(Grid.KP) <- TRUE # Plot the grid and points

## expand binding box 
#krig.KP@bbox # current data binding box
x<-c(-1, 36)
y<-c(-1, 21)
xy<-cbind(x,y)
S<-SpatialPoints(xy)
bbox(S)
krig.KP@bbox<-bbox(S) # expanded binding box for data
Grid.KP@bbox<-bbox(S) # expand for plot corner


###### KP site d15N

## d15N SOIL plot
# krig.KP<- scape.data %>% filter(Plot=="KP") # just KP
KP.soil<-  krig.KP[(krig.KP$Sample=="Soil"),] #just soil
KP.soil$Sample<-droplevels(KP.soil$Sample)

## Krig KP sites
# coordinates(KP.soil)<- ~x.meter + y.meter

# Create a grid of "Pixels" using x as columns and y as rows
# And the rows and columns of pixels:
Columns=seq(from=-1, to=36, by=0.05)
Rows=seq(from=-1, to=21, by=0.05)
Grid.KP <- expand.grid(x=Columns,y=Rows)
coordinates(Grid.KP) <- ~ x+y
gridded(Grid.KP) <- TRUE # Plot the grid and points

## expand binding box 
#KP.soil@bbox # current data binding box
x<-c(-1, 36)
y<-c(-1, 21)
xy<-cbind(x,y)
S<-SpatialPoints(xy)
bbox(S)
KP.soil@bbox<-bbox(S) # expanded binding box for data
Grid.KP@bbox<-bbox(S) # expand for plot corner

# autokrige
d15N.KP.soil <- autoKrige(d15N ~ 1, KP.soil, Grid.KP) # ordinary kriging
plot(d15N.KP.soil, sp.layout = list(pts = list("sp.points", KP.soil)))
dev.copy(pdf, "figures/notused/KP_15N_soil_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()

#d15N.KP.soil$krige_output

# Moran's I for autocorrelation
coord.soil.KP<-cbind(KP.soil$x.matrix, KP.soil$y.matrix)
res.soil.KP.N<-as.data.frame(pgirmess::correlog(coord.soil.KP, KP.soil$d15N, method="Moran"))

moran.soil.KP.d15N<-ggplot(res.soil.KP.N, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("KP: Soil d15N") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

# make to dataframes for lm, combine
KP.soil.pred.N <- d15N.KP.soil[1] %>% as.data.frame() # model predictions
KP.soil.df.N <- KP.soil %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.KP.soil.df.N<- left_join(KP.soil.df.N, KP.soil.pred.N, by = c("x.meter"="krige_output.x"))#longest axis is x
mod <- lm(krige_output.var1.pred ~ d15N, data=pred.KP.soil.df.N)
summary(mod) #R squared = 0.015

mean(pred.KP.soil.df.N$krige_output.var1.pred, na.rm=T) # mean of predictions 6.0 d15N
mean(pred.KP.soil.df.N$krige_output.var1.stdev, na.rm=T) # 0.35

# inspect model
# plot(pred.KP.soil.df.N$krige_output.var1.pred ~ pred.KP.soil.df.N$d15N, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")

########### plot to diagnostic variogram
#predicted krige
plotd15N.krig.KP.soil<-spplot(d15N.KP.soil$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{15}, N, " - KP (Restored Forest)")), cex=0.8), colorkey=FALSE)
```

RK soil isoscape
```{r, RK soil krig, message=FALSE, results='hide'}
###########################
# RK Site Krig
###########################

## d15N SOIL plot
#krig.RK<- scape.data %>% filter(Plot=="RK") # just KP
RK.soil<-  krig.RK[(krig.RK$Sample=="Soil"),] #just soil
RK.soil$Sample<-droplevels(RK.soil$Sample)

## Krig RK sites
#coordinates(RK.soil)<- ~x.meter + y.meter

# Create a grid of "Pixels" using x as columns and y as rows
# And the rows and columns of pixels:
Columns=seq(from=-1, to=21, by=0.05)
Rows=seq(from=-1, to=36, by=0.05)
Grid.RK <- expand.grid(x=Columns,y=Rows)
coordinates(Grid.RK) <- ~ x+y
gridded(Grid.RK) <- TRUE # Plot the grid and points

## expand binding box 
#RK.soil@bbox # current data binding box
x<-c(-1, 21)
y<-c(-1, 36)
xy<-cbind(x,y)
S<-SpatialPoints(xy)
bbox(S)
RK.soil@bbox<-bbox(S) # expanded binding box for data
Grid.RK@bbox<-bbox(S) # expand for plot corner

# autokrige with nugget, range and sill 
d15N.RK.soil <- autoKrige(d15N ~ 1, RK.soil, Grid.RK, fix.values = c(0,3,1)) # ordinary kriging
plot(d15N.RK.soil, sp.layout = list(pts = list("sp.points", RK.soil)))
dev.copy(pdf, "figures/notused/RK_15N_soil_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d15N.RK.soil$krige_output

# Moran's I for autocorrelation
coord.soil.RK<-cbind(RK.soil$x.matrix, RK.soil$y.matrix)
res.soil.RK.N<-as.data.frame(pgirmess::correlog(coord.soil.RK, RK.soil$d15N, method="Moran"))

moran.soil.RK.d15N<-ggplot(res.soil.RK.N, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("RK: Soil d15N") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

# make to dataframes for lm, combine
RK.soil.pred.N <- d15N.RK.soil[1] %>% as.data.frame() # model predictions
RK.soil.df.N <- RK.soil %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.RK.soil.df.N<- left_join(RK.soil.df.N, RK.soil.pred.N, by = c("x.meter"="krige_output.x"))#longest axis is x
mod <- lm(krige_output.var1.pred ~ d15N, data=pred.RK.soil.df.N)
summary(mod) #R squared = 0.01

mean(pred.RK.soil.df.N$krige_output.var1.pred, na.rm=T) # mean of predictions 6.4 d15N
mean(pred.RK.soil.df.N$krige_output.var1.stdev, na.rm=T) # 0.8

# inspect model
# plot(pred.RK.soil.df.N$krige_output.var1.pred ~ pred.RK.soil.df.N$d15N, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")


#predicted krige
plotd15N.krig.RK.soil<-spplot(d15N.RK.soil$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{15}, N, " - RK (Remnant Forest)")), cex=0.8), colorkey=TRUE)
```

combine the 15N soil isoscapes
```{r, KPRK soil krig, message=FALSE, results='hide'}
#####################
grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d15N plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(plotd15N.krig.KP.soil, plotd15N.krig.RK.soil, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/Fig5_ab.d15N.soil.isoscape.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()

```

#### δ^13^C soil-isoscape
soil isotopes, first the restored site then the remnant site  
```{r, soil isotope krigs, message=FALSE, results='hide'}
###### KP site d13C

# # autokrige with nugget, range and sill 
d13C.KP.soil <- autoKrige(d13C ~ 1, KP.soil, Grid.KP) # ordinary kriging
plot(d13C.KP.soil, sp.layout = list(pts = list("sp.points", KP.soil)))
dev.copy(pdf, "figures/notused/KP_13C_soil_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d13C.KP.soil$krige_output

# Moran's I for autocorrelation
res.soil.KP.C<-as.data.frame(pgirmess::correlog(coord.soil.KP, KP.soil$d13C, method="Moran"))

moran.soil.KP.d13C<-ggplot(res.soil.KP.C, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("KP: Soil d13C") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

# make to dataframes for lm, combine
KP.soil.pred.C <- d13C.KP.soil[1] %>% as.data.frame() # model predictions
KP.soil.df.C <- KP.soil %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.KP.soil.df.C<- left_join(KP.soil.df.C, KP.soil.pred.C, by = c("x.meter"="krige_output.x"))#longest axis is x
mod <- lm(krige_output.var1.pred ~ d13C, data=pred.KP.soil.df.C)
summary(mod) #R squared = 0.008

mean(pred.KP.soil.df.C$krige_output.var1.pred, na.rm=T) # mean of predictions -24.4 d13C
mean(pred.KP.soil.df.C$krige_output.var1.stdev, na.rm=T) # 0.6

# inspect model
# plot(pred.KP.soil.df.C$krige_output.var1.pred ~ pred.KP.soil.df.C$d13C, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")

# map in automap
#automapPlot(d13C.KP.soil$krige_output, "var1.pred", sp.layout = list("sp.points", KP.soil, pch=16, col="gray20", cex=0.5), col.regions=my.palette)

# map in ssplot
# variance
# spplot(d13C.KP.soil$krige_output,"var1.stdev")

#predicted krige
plotd13C.krig.KP.soil<-spplot(d13C.KP.soil$krige_output["var1.pred"], col.regions=col.scheme.C, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{13}, C, " - KP (Restored Forest)")), cex=0.8), colorkey=FALSE)



###########################
# RK Site Krig
###########################

# # autokrige with nugget, range and sill 
d13C.RK.soil <- autoKrige(d13C ~ 1, RK.soil, Grid.RK, fix.values = c(0,3,0.8)) # ordinary kriging
plot(d13C.RK.soil, sp.layout = list(pts = list("sp.points", RK.soil)))
dev.copy(pdf, "figures/notused/RK_13C_soil_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d13C.RK.soil$krige_output

# Moran's I for autocorrelation
res.soil.RK.C<-as.data.frame(pgirmess::correlog(coord.soil.RK, RK.soil$d13C, method="Moran"))

moran.soil.RK.d13C<-ggplot(res.soil.RK.C, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("RK: Soil d13C") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

# make to dataframes for lm, combine
RK.soil.pred.C <- d13C.RK.soil[1] %>% as.data.frame() # model predictions
RK.soil.df.C <- RK.soil %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.RK.soil.df.C<- left_join(RK.soil.df.C, RK.soil.pred.C, by = c("x.meter"="krige_output.x"))#longest axis is x
mod <- lm(krige_output.var1.pred ~ d13C, data=pred.RK.soil.df.C)
summary(mod) #R squared = 0.16

mean(pred.RK.soil.df.C$krige_output.var1.pred, na.rm=T) # mean of predictions 4.4 d13C
mean(pred.RK.soil.df.C$krige_output.var1.stdev, na.rm=T) # 2.1

# inspect model
# plot(pred.RK.soil.df.C$krige_output.var1.pred ~ pred.RK.soil.df.C$d13C, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")

# map in automap
#automapPlot(d13C.RK.soil$krige_output, "var1.pred", sp.layout = list("sp.points", RK.soil, pch=16, col="gray20", cex=0.5), col.regions=my.palette)

# map in ssplot
# variance
# spplot(d13C.RK.soil$krige_output,"var1.stdev")

#predicted krige
plotd13C.krig.RK.soil<-spplot(d13C.RK.soil$krige_output["var1.pred"], col.regions=col.scheme.C, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{13}, C, " - RK (Remnant Forest)")), cex=0.8), colorkey=TRUE)
```

combine the 13C soil-isoscapes
```{r, KPRK plants krig, message=FALSE, results='hide'}
#####################
grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d13C plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(plotd13C.krig.KP.soil, plotd13C.krig.RK.soil, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/Fig5_cd.d13C.isoscape.soils.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()

```
  
Density plots for soil isoscapes  
```{r, soil density plots, fig.show='hold', out.width='50%', message=FALSE, results='hide'}
# make density plots using predictions
# combine the predictions for each plot


############## Nitrogen plot
KP.df.soil.N<-as.data.frame(pred.KP.soil.df.N$krige_output.var1.pred); KP.df.soil.N$Plot<-"KP"
RK.df.soil.N<-as.data.frame(pred.RK.soil.df.N$krige_output.var1.pred); RK.df.soil.N$Plot<-"RK" 
colnames(KP.df.soil.N)<-c("d15N.pred", "Plot")
colnames(RK.df.soil.N)<-c("d15N.pred", "Plot")

# new dataframe
pred.soil.N<-rbind(KP.df.soil.N, RK.df.soil.N)
pred.soil.N$Plot<-as.factor(pred.soil.N$Plot)
pred.soil.N %>% 
  group_by(Plot) %>%
  summarise(no_rows = length(Plot))

#man whitney for significance (not normal data)
mwu(pred.soil.N, d15N.pred, Plot) # signif difference in predictions (p<0.001)

# Density plot SOIL
# plot.means
predict.mean.N.soil <- ddply(pred.soil.N, "Plot", summarise, 
                             grp.mean=mean(d15N.pred, na.rm=TRUE))
predict.sd.N.soil <- ddply(pred.soil.N, "Plot", summarise, sd=sd(d15N.pred, na.rm=TRUE))

density.predict.Nsoil<-ggplot(pred.soil.N, aes(x=d15N.pred)) +
  geom_density(aes(color=Plot, fill=Plot), alpha=0.5, lwd=0.4)+ xlim(2,10) +ylim(0,1.2) +
  scale_y_continuous(labels = label_number(accuracy = 0.3))+
  xlab(expression(paste("Soil ",delta^{15}, N["predicted"], sp="")))+
  theme(axis.text = element_text(size = 6), axis.ticks = element_line(size = 0.2)) +
  ylab("density")+
  scale_color_manual(values=c("#E69F00", "#56B4E9")) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  geom_vline(data=predict.mean.N.soil, aes(xintercept=grp.mean, color=Plot),
             linetype="dashed", lwd=0.2) + BW.back 
  #annotate(geom="text", x=2, y=1.2, label=expression(paste(bold("C"))), size=3)


############## Carbon
KP.df.soil.C<-as.data.frame(pred.KP.soil.df.C$krige_output.var1.pred); KP.df.soil.C$Plot<-"KP"
RK.df.soil.C<-as.data.frame(pred.RK.soil.df.C$krige_output.var1.pred); RK.df.soil.C$Plot<-"RK" 
colnames(KP.df.soil.C)<-c("d13C.pred", "Plot")
colnames(RK.df.soil.C)<-c("d13C.pred", "Plot")

# new dataframe
pred.soil.C<-rbind(KP.df.soil.C, RK.df.soil.C)
pred.soil.C$Plot<-as.factor(pred.soil.C$Plot)
pred.soil.C %>% 
  group_by(Plot) %>%
  summarise(no_rows = length(Plot))

#man whitney for significance (not normal data)
# SOIL C
mwu(pred.soil.C, d13C.pred, Plot) # signif difference in predictions (p<0.001)

# Density plot
# plot.means
predict.mean.C.soil <- ddply(pred.soil.C, "Plot", 
                             summarise, grp.mean=mean(d13C.pred, na.rm=TRUE))

density.predict.Csoil<-ggplot(pred.soil.C, aes(x=d13C.pred)) +
  geom_density(aes(color=Plot, fill=Plot), alpha=0.5, lwd=0.4)+ xlim(-28, -21) + ylim(0,0.8) +
  xlab(expression(paste("Soil ",delta^{13}, C["predicted"], sp="")))+
  ylab("")+
  theme(axis.text = element_text(size = 6), axis.ticks = element_line(size = 0.2)) +
  scale_color_manual(values=c("#E69F00", "#56B4E9")) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  geom_vline(data=predict.mean.C.soil, aes(xintercept=grp.mean, color=Plot),
             linetype="dashed", lwd=0.2) + BW.back 
  #annotate(geom="text", x=-28, y=0.8, label=expression(paste(bold("D"))), size=3)

gridExtra::grid.arrange(density.predict.Nsoil + theme(legend.position = "none"),
                        density.predict.Csoil + theme(legend.position = "none"),
                        density.legend, 
                        ncol=3, nrow=1, widths = c(1,1,0.3))

```


#### δ^15^N foliar-isoscape
  
Subset data and only examine plants.     
- *Restored forest (KP)* and *Remnant Forest (RK)*

Plant/Foliar-isoscape: Restored forest and remnant forest (Plant isoscape: d15N, Figure S5).  
Koa Plantation:
```{r, KP plants krig, message=FALSE, results='hide'}
#### d15N Plants isoscape

## d15N plants plot
# krig.KP<- scape.data %>% filter(Plot=="KP") # just KP
KP.plants<-  krig.KP[!(krig.KP$Sample=="Soil"),] #just plants, remove the soil
KP.plants$Sample<-droplevels(KP.plants$Sample)

## Krig KP sites
#coordinates(KP.plants)<- ~x.meter + y.meter

# Create a grid of "Pixels" using x as columns and y as rows
# And the rows and columns of pixels:
Columns=seq(from=-1, to=36, by=0.05)
Rows=seq(from=-1, to=21, by=0.05)
Grid.KP <- expand.grid(x=Columns,y=Rows)
coordinates(Grid.KP) <- ~ x+y
gridded(Grid.KP) <- TRUE # Plot the grid and points

## expand binding box 
#KP.plants@bbox # current data binding box
x<-c(-1, 36)
y<-c(-1, 21)
xy<-cbind(x,y)
S<-SpatialPoints(xy)
bbox(S)
KP.plants@bbox<-bbox(S) # expanded binding box for data
Grid.KP@bbox<-bbox(S) # expand for plot corner

# autokrige
d15N.KP.plants <- autoKrige(d15N ~ 1, KP.plants, Grid.KP, fix.value=c(0.2, 3, 0.6)) # ordinary kriging
plot(d15N.KP.plants, sp.layout = list(pts = list("sp.points", KP.plants)))
dev.copy(pdf, "figures/notused/KP_15N_foliar_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d15N.KP.plants$krige_output

# Moran's I for autocorrelation
coord.plants.KP<-cbind(KP.plants$x.matrix, KP.plants$y.matrix)
res.plants.KP<-as.data.frame(pgirmess::correlog(coord.plants.KP, KP.plants$d15N, method="Moran"))

moran.plants.KP.d15N<-ggplot(res.plants.KP, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("KP: Foliar d15N") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

# make to dataframes for lm, combine
KP.plants.pred.N <- d15N.KP.plants[1] %>% as.data.frame() # model predictions
KP.plants.df.N <- KP.plants %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.KP.plants.df.N<- left_join(KP.plants.df.N, KP.plants.pred.N, by = c("x.meter"="krige_output.x"))#longest axis is x
mod <- lm(krige_output.var1.pred ~ d15N, data=pred.KP.plants.df.N)
summary(mod) #R squared = 0.19

mean(pred.KP.plants.df.N$krige_output.var1.pred, na.rm=T) # mean of predictions 1.6 d15N
mean(pred.KP.plants.df.N$krige_output.var1.stdev, na.rm=T) # 0.7

# inspect model
# plot(pred.KP.plants.df.N$krige_output.var1.pred ~ pred.KP.plants.df.N$d15N, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")

#predicted krige
plotd15N.krig.KP.plants<-spplot(d15N.KP.plants$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{15}, N, " - KP (Restored Forest)")), cex=0.8), colorkey=FALSE)

#plotd15N.krig.KP.plants
```
  
Remnant Koa forest foliar isoscape
```{r, RK plants krig, message=FALSE, results='hide'}
###########################
# RK Site Krig
###########################

## d15N plants plot
#krig.RK<- scape.data %>% filter(Plot=="RK") # just RK
RK.plants<-  krig.RK[!(krig.RK$Sample=="Soil"),] #just plants, remove soil
RK.plants$Sample<-droplevels(RK.plants$Sample)

## Krig RK sites
#coordinates(RK.plants)<- ~x.meter + y.meter

# Create a grid of "Pixels" using x as columns and y as rows
# And the rows and columns of pixels:
Columns=seq(from=-1, to=21, by=0.05)
Rows=seq(from=-1, to=36, by=0.05)
Grid.RK <- expand.grid(x=Columns,y=Rows)
coordinates(Grid.RK) <- ~ x+y
gridded(Grid.RK) <- TRUE # Plot the grid and points

## expand binding box 
#RK.plants@bbox # current data binding box
x<-c(-1, 21)
y<-c(-1, 36)
xy<-cbind(x,y)
S<-SpatialPoints(xy)
bbox(S)
RK.plants@bbox<-bbox(S) # expanded binding box for data
Grid.RK@bbox<-bbox(S) # expand for plot corner

# autokrige
d15N.RK.plants <- autoKrige(d15N ~ 1, RK.plants, Grid.RK, fix.values = c(NA, 5, NA)) # ordinary kriging
plot(d15N.RK.plants, sp.layout = list(pts = list("sp.points", RK.plants)))
dev.copy(pdf, "figures/notused/RK_15N_foliar_variogram.pdf", width=9, height=5, encod="MacRoman")
dev.off()
#d15N.RK.plants$krige_output

# Moran's I for autocorrelation
coord.plants.RK<-cbind(RK.plants$x.matrix, RK.plants$y.matrix)
res.plants.RK.N<-as.data.frame(pgirmess::correlog(coord.plants.RK, RK.plants$d15N, method="Moran"))

moran.plants.RK.d15N<-ggplot(res.plants.RK.N, aes(x=dist.class, y=coef))+
  geom_point(size=2, pch=16) +
  geom_smooth(method=loess, alpha=0.1) +
  ggtitle("RK: Foliar d15N") +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") + 
  theme_classic()

# make to dataframes for lm, combine
RK.plants.pred.N <- d15N.RK.plants[1] %>% as.data.frame() # model predictions
RK.plants.df.N <- RK.plants %>% as.data.frame() # dataframe

# make dataframe with data and predictions (krig) to assess fit
pred.RK.plants.df.N<- left_join(RK.plants.df.N, RK.plants.pred.N, by = c("x.meter"="krige_output.x"))#longest axis is x
mod <- lm(krige_output.var1.pred ~ d15N, data=pred.RK.plants.df.N)
summary(mod) #R squared = 0.15

mean(pred.RK.plants.df.N$krige_output.var1.pred, na.rm=T) # mean of predictions 2.8 d15N
mean(pred.RK.plants.df.N$krige_output.var1.stdev, na.rm=T) # 0.5

# inspect model
# plot(pred.RK.plants.df.N$krige_output.var1.pred ~ pred.RK.plants.df.N$d15N, xlab = "Observed", ylab = "Predicted", cex=0.2); abline(0,1, lty=2); abline(mod, col = "blue")

# Adding the sp.layout parameter shows the locations of the measurements
my.palette <- brewer.pal(n = 9, name = "RdBu")


#predicted krige
plotd15N.krig.RK.plants<-spplot(d15N.RK.plants$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=expression(paste(delta^{15}, N, " - RK (Remnant Forest)")), cex=0.8), colorkey=TRUE)
#plotd15N.krig.RK.plants
```
  
combine the two foliar-isoscapes
```{r, KPRK plants krig, message=FALSE, results='hide'}
#####################
grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d15N plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(plotd15N.krig.KP.plants, plotd15N.krig.RK.plants, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/Fig 6_ab.d15N.isoscape.plants.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()

```
  
Density plots showing the distribution of all extrapolated points.
Plant-isoscape: density plot for the d15N-predicted values for the plant-only (foliar) isoscape
```{r, plant density, fig.show='hide', message=FALSE, results='hide'}
# make density plots using predictions
# combine the predictions for each plot

############## Nitrogen plot
KP.df.plants.N<-as.data.frame(pred.KP.plants.df.N$krige_output.var1.pred); KP.df.plants.N$Plot<-"KP"
RK.df.plants.N<-as.data.frame(pred.RK.plants.df.N$krige_output.var1.pred); RK.df.plants.N$Plot<-"RK" 
colnames(KP.df.plants.N)<-c("d15N.pred", "Plot")
colnames(RK.df.plants.N)<-c("d15N.pred", "Plot")

# new dataframe
pred.plants.N<-rbind(KP.df.plants.N, RK.df.plants.N)
pred.plants.N$Plot<-as.factor(pred.plants.N$Plot)
pred.plants.N %>% 
  group_by(Plot) %>%
  summarise(no_rows = length(Plot))

#man whitney for significance (not normal data)
# PLANT N
mwu(pred.plants.N, d15N.pred, Plot) # signif difference in predictions (p<0.001)

### Density plot

# plot.means
predict.mean.N <- ddply(pred.plants.N, "Plot", summarise, grp.mean=mean(d15N.pred, na.rm=TRUE))
predict.SD.N <- ddply(pred.plants.N, "Plot", summarise, sd=sd(d15N.pred, na.rm=TRUE))

density.predict.Nplants<-ggplot(pred.plants.N, aes(x=d15N.pred)) +
  geom_density(aes(color=Plot, fill=Plot), alpha=0.5, lwd=0.4)+ ylim(0,2.5) +
  xlab(expression(paste("Foliar ", delta^{15}, N["predicted"], sp="")))+
  theme(axis.text = element_text(size = 6), axis.ticks = element_line(size = 0.2))+
  scale_color_manual(values=c("#E69F00", "#56B4E9")) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  #annotate(geom="text", x=0, y=2.5, label=expression(paste(bold("E"))), size=3) +
  geom_vline(data=predict.mean.N, aes(xintercept=grp.mean, color=Plot),
             linetype="dashed", lwd=0.2) + BW.back

```


```{r, foliar density plots, fig.show='hold', out.width='50%', message=FALSE, results='hide'}
### group all density plots

fig.format3<-theme(panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(),
                   panel.background = element_blank(), 
                   axis.line = element_line(colour = "black", size=0.2), 
                   text = element_text(size = 6))

density.legend <- get_legend(
  density.predict.Nsoil + 
    theme(legend.box.margin = margin(0, 0, 0, 12)) +
    theme(legend.title=element_blank())+ # no need for a title above legend
    theme(legend.key.size = unit(0.5, "cm")))

plot_grid((density.predict.Nsoil + ylab("density") + theme(legend.position = "none") +
             fig.format3),
          (density.predict.Csoil + ylab("")+ theme(legend.position = "none") + fig.format3),
          (density.predict.Nplants + theme(legend.position = "none") + fig.format3),
          density.legend, 
          labels=c('A', 'B', 'C', ''), label_size=8, hjust=-1, vjust= 2, ncol=4, nrow=1)


dev.copy(pdf, "figures/Fig 4_ac_density plots.pdf", width = 7, height = 3)
dev.off()
```


```{r, leaves N, eval=FALSE}
#### foliar N-scape
# autokrige
N.KP.plants <- autoKrige(Total.N..mmol.gdw ~ 1, KP.plants, Grid.KP) 
plot(N.KP.plants)


#predicted krige
N.krig.KP.plants<-spplot(N.KP.plants$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
      main=list(label=" Foliar N content- KP"), cex=0.8, colorkey=FALSE)


# autokrige
N.RK.plants <- autoKrige(Total.N..mmol.gdw ~ 1, RK.plants, Grid.RK, fix.values = c(0, 5, 0.06))
plot(N.RK.plants, sp.layout = list(pts = list("sp.points", RK.plants)))

N.krig.RK.plants<-spplot(N.RK.plants$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=" Foliar N content- RK"), cex=0.8, colorkey=TRUE)




grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d15N plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(N.krig.KP.plants, N.krig.RK.plants, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/Figx. N.isoscape.plants.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()



################## soil
# autokrige
N.KP.soil <- autoKrige(Total.N..mmol.gdw ~ 1, KP.soil, Grid.KP, fix.value=c(0.02, 5, 0.08)) 
plot(N.KP.soil)


#predicted krige
N.krig.KP.soil<-spplot(N.KP.soil$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.KP, pch=c(17,2,1)[krig.KP$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
      main=list(label=" Soil N content- KP"), cex=0.8, colorkey=FALSE)


# autokrige
N.RK.soil <- autoKrige(Total.N..mmol.gdw ~ 1, RK.soil, Grid.RK, fix.values = c(0.02, 5, 0.06)) # ordinary kriging
plot(N.RK.soil, sp.layout = list(pts = list("sp.points", RK.soil)))

N.krig.RK.soil<-spplot(N.RK.soil$krige_output["var1.pred"], col.regions=col.scheme.N, 
       sp.layout = list("sp.points", krig.RK, pch=c(17,2,1)[krig.RK$Sample], 
                        col=c("black"), cex=0.8, alpha=0.5),
       main=list(label=" Soil N content- RK"), cex=0.8, colorkey=TRUE)




grid.draw.ggmatrix <- function(x, recording = TRUE) {
  print(x)
}
### combined KP-Rk krig d15N plot 
par(mfrow=c(1,2))
gridExtra::grid.arrange(N.krig.KP.soil, N.krig.RK.soil, ncol=2, nrow=1) #widths = c(1.2,1))
dev.copy(png, "figures/Figx. N.isoscape.soil.png", width = 8, height = 4, units = 'in', res = 300)
dev.off()

```

